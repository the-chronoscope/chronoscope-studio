---
export const prerender = false;
const client_id = import.meta.env.KEYSTATIC_GITHUB_CLIENT_ID;
const client_secret = import.meta.env.KEYSTATIC_GITHUB_CLIENT_SECRET;

let result = null;
let error = null;

const url = new URL(Astro.request.url);
const code = url.searchParams.get('code');

if (code) {
  try {
    // Manually exchange the code for a token
    const response = await fetch('https://github.com/login/oauth/access_token', {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json', 
        'Accept': 'application/json' 
      },
      body: JSON.stringify({ client_id, client_secret, code })
    });
    result = await response.json();
  } catch (e) {
    error = e.message;
  }
}
---

<div style="background: #111; color: #0f0; padding: 40px; font-family: monospace;">
  <h1>Auth X-Ray</h1>
  <p><strong>Client ID Loaded:</strong> {client_id ? 'YES' : 'NO'}</p>
  <p><strong>Client Secret Loaded:</strong> {client_secret ? 'YES' : 'NO'}</p>

  {!code && (
    <a href={`https://github.com/login/oauth/authorize?client_id=${client_id}&redirect_uri=${url.origin}/debug-auth`} 
       style="background: #0f0; color: #000; padding: 10px; text-decoration: none;">
       1. START MANUAL TEST
    </a>
  )}

  {result && (
    <div>
      <h3>2. GITHUB RESPONSE:</h3>
      <pre>{JSON.stringify(result, null, 2)}</pre>
    </div>
  )}
  
  {error && <div style="color: red">ERROR: {error}</div>}
</div>
